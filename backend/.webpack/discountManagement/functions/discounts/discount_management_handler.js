(()=>{var e={117:(e,t,s)=>{"use strict";s.r(t),s.d(t,{NIL:()=>A,parse:()=>v,stringify:()=>l,v1:()=>y,v3:()=>b,v4:()=>_,v5:()=>h,validate:()=>c,version:()=>w});const i=require("crypto");var n=s.n(i);const r=new Uint8Array(256);let a=r.length;function o(){return a>r.length-16&&(n().randomFillSync(r),a=0),r.slice(a,a+=16)}const u=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,c=function(e){return"string"==typeof e&&u.test(e)},d=[];for(let e=0;e<256;++e)d.push((e+256).toString(16).substr(1));const l=function(e,t=0){const s=(d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+"-"+d[e[t+4]]+d[e[t+5]]+"-"+d[e[t+6]]+d[e[t+7]]+"-"+d[e[t+8]]+d[e[t+9]]+"-"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]).toLowerCase();if(!c(s))throw TypeError("Stringified UUID is invalid");return s};let m,p,f=0,g=0;const y=function(e,t,s){let i=t&&s||0;const n=t||new Array(16);let r=(e=e||{}).node||m,a=void 0!==e.clockseq?e.clockseq:p;if(null==r||null==a){const t=e.random||(e.rng||o)();null==r&&(r=m=[1|t[0],t[1],t[2],t[3],t[4],t[5]]),null==a&&(a=p=16383&(t[6]<<8|t[7]))}let u=void 0!==e.msecs?e.msecs:Date.now(),c=void 0!==e.nsecs?e.nsecs:g+1;const d=u-f+(c-g)/1e4;if(d<0&&void 0===e.clockseq&&(a=a+1&16383),(d<0||u>f)&&void 0===e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");f=u,g=c,p=a,u+=122192928e5;const y=(1e4*(268435455&u)+c)%4294967296;n[i++]=y>>>24&255,n[i++]=y>>>16&255,n[i++]=y>>>8&255,n[i++]=255&y;const v=u/4294967296*1e4&268435455;n[i++]=v>>>8&255,n[i++]=255&v,n[i++]=v>>>24&15|16,n[i++]=v>>>16&255,n[i++]=a>>>8|128,n[i++]=255&a;for(let e=0;e<6;++e)n[i+e]=r[e];return t||l(n)},v=function(e){if(!c(e))throw TypeError("Invalid UUID");let t;const s=new Uint8Array(16);return s[0]=(t=parseInt(e.slice(0,8),16))>>>24,s[1]=t>>>16&255,s[2]=t>>>8&255,s[3]=255&t,s[4]=(t=parseInt(e.slice(9,13),16))>>>8,s[5]=255&t,s[6]=(t=parseInt(e.slice(14,18),16))>>>8,s[7]=255&t,s[8]=(t=parseInt(e.slice(19,23),16))>>>8,s[9]=255&t,s[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,s[11]=t/4294967296&255,s[12]=t>>>24&255,s[13]=t>>>16&255,s[14]=t>>>8&255,s[15]=255&t,s};function I(e,t,s){function i(e,i,n,r){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));const t=[];for(let s=0;s<e.length;++s)t.push(e.charCodeAt(s));return t}(e)),"string"==typeof i&&(i=v(i)),16!==i.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let a=new Uint8Array(16+e.length);if(a.set(i),a.set(e,i.length),a=s(a),a[6]=15&a[6]|t,a[8]=63&a[8]|128,n){r=r||0;for(let e=0;e<16;++e)n[r+e]=a[e];return n}return l(a)}try{i.name=e}catch(e){}return i.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",i.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",i}const b=I("v3",48,function(e){return Array.isArray(e)?e=Buffer.from(e):"string"==typeof e&&(e=Buffer.from(e,"utf8")),n().createHash("md5").update(e).digest()}),_=function(e,t,s){const i=(e=e||{}).random||(e.rng||o)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){s=s||0;for(let e=0;e<16;++e)t[s+e]=i[e];return t}return l(i)},h=I("v5",80,function(e){return Array.isArray(e)?e=Buffer.from(e):"string"==typeof e&&(e=Buffer.from(e,"utf8")),n().createHash("sha1").update(e).digest()}),A="00000000-0000-0000-0000-000000000000",w=function(e){if(!c(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)}},337:e=>{"use strict";e.exports={createResponse:function(e,t){return{statusCode:e,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS"},body:JSON.stringify(t)}}}},496:e=>{"use strict";e.exports=require("aws-sdk")}},t={};function s(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,s),r.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{var e=i;const t=s(496),{v4:n}=s(117),{createResponse:r}=s(337),a=process.env.DISCOUNTS_TABLE||"OrderReceiver-Discounts";async function o(e,t,s){try{const i={TableName:a,Key:{discountId:s}},n=await e.get(i).promise();return n.Item?n.Item.businessId!==t?r(403,{success:!1,message:"Access denied to this discount"}):r(200,{success:!0,discount:n.Item}):r(404,{success:!1,message:"Discount not found"})}catch(e){return console.error("Error getting discount:",e),r(500,{success:!1,message:"Failed to retrieve discount"})}}async function u(e,t,s){try{const{discountId:i,orderTotal:n,items:o}=s;if(!i||void 0===n||!o)return r(400,{success:!1,message:"Missing required fields: discountId, orderTotal, items"});const u={TableName:a,Key:{discountId:i}},c=await e.get(u).promise();if(!c.Item)return r(404,{success:!1,message:"Discount not found"});const d=c.Item;if(d.businessId!==t)return r(403,{success:!1,message:"Access denied to this discount"});if("active"!==d.status)return r(400,{success:!1,message:"Discount is not active",valid:!1});const l=new Date,m=new Date(d.validFrom),p=new Date(d.validTo);if(l<m||l>p)return r(400,{success:!1,message:"Discount is not valid for current date",valid:!1});if(n<d.minimumOrderAmount)return r(400,{success:!1,message:`Order must be at least $${d.minimumOrderAmount}`,valid:!1});if(d.usageLimit&&d.usageCount>=d.usageLimit)return r(400,{success:!1,message:"Discount usage limit reached",valid:!1});const f=function(e,t,s){let i=0;switch(e.applicability){case"allItems":case"minimumOrder":default:i=t;break;case"specificItems":i=s.filter(t=>e.applicable_item_ids.includes(t.dishId||t.id)).reduce((e,t)=>e+t.price*t.quantity,0);break;case"specificCategories":i=s.filter(t=>e.applicable_category_ids.includes(t.categoryId)).reduce((e,t)=>e+t.price*t.quantity,0)}switch(e.type){case"percentage":return i*(e.value/100);case"fixedAmount":default:return Math.min(e.value,i);case"buyXGetY":case"conditional":return function(e,t){const s=e.conditionalParameters||{},i=s.buyItemId,n=s.buyQuantity,r=s.getItemId,a=s.getQuantity;if(!(i&&n&&r&&a))return 0;const o=t.find(e=>(e.dishId||e.id)===i);if(!o||o.quantity<n)return 0;const u=t.find(e=>(e.dishId||e.id)===r);if(!u)return 0;const c=Math.floor(o.quantity/n),d=Math.min(c*a,u.quantity);return 0===e.value?d*u.price:d*u.price*(e.value/100)}(e,s);case"freeDelivery":return 0}}(d,n,o);return r(200,{success:!0,valid:!0,discountAmount:f,discount:d})}catch(e){return console.error("Error validating discount:",e),r(500,{success:!1,message:"Failed to validate discount"})}}process.env.COGNITO_USER_POOL_ID,e.handler=async e=>{console.log("Discount Management Handler - Event:",JSON.stringify(e,null,2));const s=new t.CognitoIdentityServiceProvider({region:process.env.AWS_REGION||"us-east-1"}),i=new t.DynamoDB.DocumentClient({region:process.env.AWS_REGION||"us-east-1"}),{httpMethod:c,path:d,pathParameters:l,body:m,headers:p}=e;try{const e=p?.Authorization||p?.authorization;if(!e||!e.startsWith("Bearer "))return r(401,{success:!1,message:"Missing or invalid authorization header"});const t=e.replace("Bearer ",""),f=await async function(e,t){try{const s=await e.getUser({AccessToken:t}).promise(),i=s.UserAttributes.find(e=>"email"===e.Name)?.Value,n=s.UserAttributes.find(e=>"sub"===e.Name)?.Value;return{userId:n,email:i,cognitoUserId:n}}catch(e){return console.error("Error getting user info from token:",e),null}}(s,t);if(!f)return r(401,{success:!1,message:"Invalid access token"});const g=await async function(e,t){try{const s={TableName:process.env.BUSINESSES_TABLE||"OrderReceiver-Businesses",IndexName:"email-index",KeyConditionExpression:"email = :email",ExpressionAttributeValues:{":email":t}},i=await e.query(s).promise();return i.Items?.[0]||null}catch(e){return console.error("Error getting business info:",e),null}}(i,f.email);return g?"GET"===c&&"/discounts"===d?await async function(e,t){try{const s={TableName:a,IndexName:"BusinessIdIndex",KeyConditionExpression:"businessId = :businessId",ExpressionAttributeValues:{":businessId":t}},i=await e.query(s).promise();return r(200,{success:!0,discounts:i.Items||[],count:i.Items?.length||0})}catch(e){return console.error("Error getting discounts:",e),r(500,{success:!1,message:"Failed to retrieve discounts",error:e.message})}}(i,g.business_id):"POST"===c&&"/discounts"===d?await async function(e,t,s){try{const i=["title","type","value","validFrom","validTo"];for(const e of i)if(!s[e])return r(400,{success:!1,message:`Missing required field: ${e}`});if(!["percentage","fixedAmount","conditional","freeDelivery","buyXGetY","others"].includes(s.type))return r(400,{success:!1,message:"Invalid discount type"});const o=["allItems","specificItems","specificCategories","minimumOrder"];if(s.applicability&&!o.includes(s.applicability))return r(400,{success:!1,message:"Invalid discount applicability"});if("buyXGetY"===s.type||"conditional"===s.type){const e=s.conditionalParameters||{};if(!(e.buyItemId&&e.getItemId&&e.buyQuantity&&e.getQuantity))return r(400,{success:!1,message:"Missing required fields for Buy X Get Y discount"})}const u=n(),c=(new Date).toISOString(),d={businessId:t,discountId:u,id:u,title:s.title,description:s.description||"",type:s.type,value:parseFloat(s.value),applicability:s.applicability||"allItems",applicable_item_ids:s.applicableItemIds||[],applicable_category_ids:s.applicableCategoryIds||[],minimum_order_amount:parseFloat(s.minimumOrderAmount||0),valid_from:s.validFrom,valid_to:s.validTo,usage_limit:s.usageLimit||null,usage_count:0,status:s.status||"active",conditional_rule:s.conditionalRule||null,conditional_parameters:s.conditionalParameters||{},created_at:c,updated_at:c},l={TableName:a,Item:d};return await e.put(l).promise(),r(201,{success:!0,message:"Discount created successfully",discount:d})}catch(e){return console.error("Error creating discount:",e),r(500,{success:!1,message:"Failed to create discount"})}}(i,g.business_id,JSON.parse(m||"{}")):"GET"===c&&l?.discountId?await o(i,g.business_id,l.discountId):"PUT"===c&&l?.discountId?await async function(e,t,s,i){try{const n=await o(e,t,s);if(200!==n.statusCode)return n;let u="SET updated_at = :timestamp";const c={":timestamp":(new Date).toISOString()};void 0!==i.title&&(u+=", title = :title",c[":title"]=i.title),void 0!==i.description&&(u+=", description = :description",c[":description"]=i.description),void 0!==i.value&&(u+=", value = :value",c[":value"]=parseFloat(i.value)),void 0!==i.applicability&&(u+=", applicability = :applicability",c[":applicability"]=i.applicability),void 0!==i.applicableItemIds&&(u+=", applicable_item_ids = :applicable_item_ids",c[":applicable_item_ids"]=i.applicableItemIds),void 0!==i.applicableCategoryIds&&(u+=", applicable_category_ids = :applicable_category_ids",c[":applicable_category_ids"]=i.applicableCategoryIds),void 0!==i.minimumOrderAmount&&(u+=", minimum_order_amount = :minimum_order_amount",c[":minimum_order_amount"]=parseFloat(i.minimumOrderAmount)),void 0!==i.validFrom&&(u+=", valid_from = :valid_from",c[":valid_from"]=i.validFrom),void 0!==i.validTo&&(u+=", valid_to = :valid_to",c[":valid_to"]=i.validTo),void 0!==i.usageLimit&&(u+=", usage_limit = :usage_limit",c[":usage_limit"]=i.usageLimit),void 0!==i.status&&(u+=", status = :status",c[":status"]=i.status),void 0!==i.conditionalRule&&(u+=", conditional_rule = :conditional_rule",c[":conditional_rule"]=i.conditionalRule),void 0!==i.conditionalParameters&&(u+=", conditional_parameters = :conditional_parameters",c[":conditional_parameters"]=i.conditionalParameters),u+=", updated_at = :updatedAt",c[":updatedAt"]=(new Date).toISOString();const d={TableName:a,Key:{discountId:s},UpdateExpression:u,ExpressionAttributeValues:c,ReturnValues:"ALL_NEW"},l=await e.update(d).promise();return r(200,{success:!0,message:"Discount updated successfully",discount:l.Attributes})}catch(e){return console.error("Error updating discount:",e),r(500,{success:!1,message:"Failed to update discount"})}}(i,g.business_id,l.discountId,JSON.parse(m||"{}")):"DELETE"===c&&l?.discountId?await async function(e,t,s){try{const i={TableName:a,Key:{discountId:s}},n=await e.get(i).promise();if(!n.Item)return r(404,{success:!1,message:"Discount not found"});if(n.Item.businessId!==t)return r(403,{success:!1,message:"Access denied to this discount"});const o={TableName:a,Key:{discountId:s},ReturnValues:"ALL_OLD"};return(await e.delete(o).promise()).Attributes?r(200,{success:!0,message:"Discount deleted successfully"}):r(404,{success:!1,message:"Discount not found"})}catch(e){return console.error("Error deleting discount:",e),r(500,{success:!1,message:"Failed to delete discount"})}}(i,g.business_id,l.discountId):"PATCH"===c&&l?.discountId&&d.includes("/toggle-status")?await async function(e,t,s){try{const i={TableName:a,Key:{discountId:s}},n=await e.get(i).promise();if(!n.Item)return r(404,{success:!1,message:"Discount not found"});if(n.Item.businessId!==t)return r(403,{success:!1,message:"Access denied to this discount"});const o="active"===n.Item.status?"paused":"active",u={TableName:a,Key:{discountId:s},UpdateExpression:"SET #status = :status, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":status":o,":updatedAt":(new Date).toISOString()},ReturnValues:"ALL_NEW"},c=await e.update(u).promise();return r(200,{success:!0,message:`Discount status changed to ${o}`,discount:c.Attributes})}catch(e){return console.error("Error toggling discount status:",e),r(500,{success:!1,message:"Failed to toggle discount status"})}}(i,g.business_id,l.discountId):"POST"===c&&d.includes("/validate-discount")?await u(i,g.business_id,JSON.parse(m||"{}")):"POST"===c&&d.includes("/apply-discount")?await async function(e,t,s){try{const{discountId:i,orderTotal:n,items:o}=s,c=await u(e,t,s);if(200!==c.statusCode)return c;const d=JSON.parse(c.body),l=d.discount,m=d.discountAmount,p={TableName:a,Key:{discountId:i},UpdateExpression:"SET #usageCount = #usageCount + :inc, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#usageCount":"usageCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":inc":1,":updatedAt":(new Date).toISOString()}};return await e.update(p).promise(),r(200,{success:!0,message:"Discount applied successfully",discountAmount:m,finalTotal:n-m,discount:l})}catch(e){return console.error("Error applying discount:",e),r(500,{success:!1,message:"Failed to apply discount"})}}(i,g.business_id,JSON.parse(m||"{}")):"GET"===c&&d.includes("/stats")?await async function(e,t){try{const s={TableName:a,IndexName:"BusinessIdIndex",KeyConditionExpression:"businessId = :businessId",ExpressionAttributeValues:{":businessId":t}},i=(await e.query(s).promise()).Items||[],n={totalDiscounts:i.length,activeDiscounts:i.filter(e=>"active"===e.status).length,expiredDiscounts:i.filter(e=>new Date(e.validTo)<new Date).length,totalUsage:i.reduce((e,t)=>e+(t.usageCount||0),0),discountsByType:{}};return["percentage","fixedAmount","conditional","freeDelivery","buyXGetY","others"].forEach(e=>{n.discountsByType[e]=i.filter(t=>t.type===e).length}),r(200,{success:!0,stats:n})}catch(e){return console.error("Error getting discount stats:",e),r(500,{success:!1,message:"Failed to retrieve discount statistics"})}}(i,g.business_id):r(404,{success:!1,message:"Endpoint not found"}):r(404,{success:!1,message:"Business not found for user"})}catch(e){return console.error("Error in discount management handler:",e),r(500,{success:!1,message:"Internal server error",error:e.message})}}})();var n=exports;for(var r in i)n[r]=i[r];i.__esModule&&Object.defineProperty(n,"__esModule",{value:!0})})();