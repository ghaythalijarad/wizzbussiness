(()=>{var e={117:(e,t,s)=>{"use strict";s.r(t),s.d(t,{NIL:()=>E,parse:()=>b,stringify:()=>l,v1:()=>y,v3:()=>v,v4:()=>A,v5:()=>h,validate:()=>c,version:()=>w});const n=require("crypto");var i=s.n(n);const r=new Uint8Array(256);let a=r.length;function o(){return a>r.length-16&&(i().randomFillSync(r),a=0),r.slice(a,a+=16)}const u=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,c=function(e){return"string"==typeof e&&u.test(e)},d=[];for(let e=0;e<256;++e)d.push((e+256).toString(16).substr(1));const l=function(e,t=0){const s=(d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+"-"+d[e[t+4]]+d[e[t+5]]+"-"+d[e[t+6]]+d[e[t+7]]+"-"+d[e[t+8]]+d[e[t+9]]+"-"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]).toLowerCase();if(!c(s))throw TypeError("Stringified UUID is invalid");return s};let p,m,f=0,g=0;const y=function(e,t,s){let n=t&&s||0;const i=t||new Array(16);let r=(e=e||{}).node||p,a=void 0!==e.clockseq?e.clockseq:m;if(null==r||null==a){const t=e.random||(e.rng||o)();null==r&&(r=p=[1|t[0],t[1],t[2],t[3],t[4],t[5]]),null==a&&(a=m=16383&(t[6]<<8|t[7]))}let u=void 0!==e.msecs?e.msecs:Date.now(),c=void 0!==e.nsecs?e.nsecs:g+1;const d=u-f+(c-g)/1e4;if(d<0&&void 0===e.clockseq&&(a=a+1&16383),(d<0||u>f)&&void 0===e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");f=u,g=c,m=a,u+=122192928e5;const y=(1e4*(268435455&u)+c)%4294967296;i[n++]=y>>>24&255,i[n++]=y>>>16&255,i[n++]=y>>>8&255,i[n++]=255&y;const b=u/4294967296*1e4&268435455;i[n++]=b>>>8&255,i[n++]=255&b,i[n++]=b>>>24&15|16,i[n++]=b>>>16&255,i[n++]=a>>>8|128,i[n++]=255&a;for(let e=0;e<6;++e)i[n+e]=r[e];return t||l(i)},b=function(e){if(!c(e))throw TypeError("Invalid UUID");let t;const s=new Uint8Array(16);return s[0]=(t=parseInt(e.slice(0,8),16))>>>24,s[1]=t>>>16&255,s[2]=t>>>8&255,s[3]=255&t,s[4]=(t=parseInt(e.slice(9,13),16))>>>8,s[5]=255&t,s[6]=(t=parseInt(e.slice(14,18),16))>>>8,s[7]=255&t,s[8]=(t=parseInt(e.slice(19,23),16))>>>8,s[9]=255&t,s[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,s[11]=t/4294967296&255,s[12]=t>>>24&255,s[13]=t>>>16&255,s[14]=t>>>8&255,s[15]=255&t,s};function I(e,t,s){function n(e,n,i,r){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));const t=[];for(let s=0;s<e.length;++s)t.push(e.charCodeAt(s));return t}(e)),"string"==typeof n&&(n=b(n)),16!==n.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let a=new Uint8Array(16+e.length);if(a.set(n),a.set(e,n.length),a=s(a),a[6]=15&a[6]|t,a[8]=63&a[8]|128,i){r=r||0;for(let e=0;e<16;++e)i[r+e]=a[e];return i}return l(a)}try{n.name=e}catch(e){}return n.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",n.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",n}const v=I("v3",48,function(e){return Array.isArray(e)?e=Buffer.from(e):"string"==typeof e&&(e=Buffer.from(e,"utf8")),i().createHash("md5").update(e).digest()}),A=function(e,t,s){const n=(e=e||{}).random||(e.rng||o)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){s=s||0;for(let e=0;e<16;++e)t[s+e]=n[e];return t}return l(n)},h=I("v5",80,function(e){return Array.isArray(e)?e=Buffer.from(e):"string"==typeof e&&(e=Buffer.from(e,"utf8")),i().createHash("sha1").update(e).digest()}),E="00000000-0000-0000-0000-000000000000",w=function(e){if(!c(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)}},337:e=>{"use strict";e.exports={createResponse:function(e,t){return{statusCode:e,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS"},body:JSON.stringify(t)}}}},496:e=>{"use strict";e.exports=require("aws-sdk")}},t={};function s(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,s),r.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{var e=n;const t=s(496),{v4:i}=s(117),{createResponse:r}=s(337),a=process.env.DISCOUNTS_TABLE||"OrderReceiver-Discounts";async function o(e,t,s){try{const{discountId:n,orderTotal:i,items:o}=s;if(!n||void 0===i||!o)return r(400,{success:!1,message:"Missing required fields: discountId, orderTotal, items"});const u={TableName:a,Key:{business_id:t,discountId:n}},c=await e.get(u).promise();if(!c.Item)return r(404,{success:!1,message:"Discount not found"});const d=c.Item;if("active"!==d.status)return r(400,{success:!1,message:"Discount is not active",valid:!1});const l=new Date,p=new Date(d.validFrom),m=new Date(d.validTo);if(l<p||l>m)return r(400,{success:!1,message:"Discount is not valid for current date",valid:!1});if(i<d.minimumOrderAmount)return r(400,{success:!1,message:`Order must be at least $${d.minimumOrderAmount}`,valid:!1});if(d.usageLimit&&d.usageCount>=d.usageLimit)return r(400,{success:!1,message:"Discount usage limit reached",valid:!1});const f=function(e,t,s){let n=0;switch(e.applicability){case"allItems":case"minimumOrder":default:n=t;break;case"specificItems":n=s.filter(t=>e.applicableItemIds.includes(t.dishId||t.id)).reduce((e,t)=>e+t.price*t.quantity,0);break;case"specificCategories":n=s.filter(t=>e.applicableCategoryIds.includes(t.categoryId)).reduce((e,t)=>e+t.price*t.quantity,0)}switch(e.type){case"percentage":return n*(e.value/100);case"fixedAmount":default:return Math.min(e.value,n);case"buyXGetY":case"conditional":return function(e,t){const s=e.conditionalParameters||{},n=s.buyItemId,i=s.buyQuantity,r=s.getItemId,a=s.getQuantity;if(!(n&&i&&r&&a))return 0;const o=t.find(e=>(e.dishId||e.id)===n);if(!o||o.quantity<i)return 0;const u=t.find(e=>(e.dishId||e.id)===r);if(!u)return 0;const c=Math.floor(o.quantity/i),d=Math.min(c*a,u.quantity);return 0===e.value?d*u.price:d*u.price*(e.value/100)}(e,s);case"freeDelivery":return 0}}(d,i,o);return r(200,{success:!0,valid:!0,discountAmount:f,discount:d})}catch(e){return console.error("Error validating discount:",e),r(500,{success:!1,message:"Failed to validate discount"})}}process.env.COGNITO_USER_POOL_ID,e.handler=async e=>{console.log("Discount Management Handler - Event:",JSON.stringify(e,null,2));const s=new t.CognitoIdentityServiceProvider({region:process.env.AWS_REGION||"us-east-1"}),n=new t.DynamoDB.DocumentClient({region:process.env.AWS_REGION||"us-east-1"}),{httpMethod:u,path:c,pathParameters:d,body:l,headers:p}=e;try{const e=p?.Authorization||p?.authorization;if(!e||!e.startsWith("Bearer "))return r(401,{success:!1,message:"Missing or invalid authorization header"});const t=e.replace("Bearer ",""),m=await async function(e,t){try{const s=await e.getUser({AccessToken:t}).promise(),n=s.UserAttributes.find(e=>"email"===e.Name)?.Value,i=s.UserAttributes.find(e=>"sub"===e.Name)?.Value;return{userId:i,email:n,cognitoUserId:i}}catch(e){return console.error("Error getting user info from token:",e),null}}(s,t);if(!m)return r(401,{success:!1,message:"Invalid access token"});const f=await async function(e,t){try{const s={TableName:process.env.BUSINESSES_TABLE||"OrderReceiver-Businesses",IndexName:"email-index",KeyConditionExpression:"email = :email",ExpressionAttributeValues:{":email":t}},n=await e.query(s).promise();return n.Items?.[0]||null}catch(e){return console.error("Error getting business info:",e),null}}(n,m.email);return f?"GET"===u&&"/discounts"===c?await async function(e,t){try{const s={TableName:a,KeyConditionExpression:"business_id = :businessId",ExpressionAttributeValues:{":businessId":t},ScanIndexForward:!1},n=await e.query(s).promise();return r(200,{success:!0,discounts:n.Items||[],count:n.Items?.length||0})}catch(e){return console.error("Error getting discounts:",e),r(500,{success:!1,message:"Failed to retrieve discounts"})}}(n,f.business_id):"POST"===u&&"/discounts"===c?await async function(e,t,s){try{const n=["title","type","value","validFrom","validTo"];for(const e of n)if(!s[e])return r(400,{success:!1,message:`Missing required field: ${e}`});if(!["percentage","fixedAmount","conditional","freeDelivery","buyXGetY","others"].includes(s.type))return r(400,{success:!1,message:"Invalid discount type"});const o=["allItems","specificItems","specificCategories","minimumOrder"];if(s.applicability&&!o.includes(s.applicability))return r(400,{success:!1,message:"Invalid discount applicability"});if("buyXGetY"===s.type||"conditional"===s.type){const e=s.conditionalParameters||{};if(!(e.buyItemId&&e.getItemId&&e.buyQuantity&&e.getQuantity))return r(400,{success:!1,message:"Missing required fields for Buy X Get Y discount"})}const u=i(),c=(new Date).toISOString(),d={business_id:t,discountId:u,id:u,title:s.title,description:s.description||"",type:s.type,value:parseFloat(s.value),applicability:s.applicability||"allItems",applicableItemIds:s.applicableItemIds||[],applicableCategoryIds:s.applicableCategoryIds||[],minimumOrderAmount:parseFloat(s.minimumOrderAmount||0),validFrom:s.validFrom,validTo:s.validTo,usageLimit:s.usageLimit||null,usageCount:0,status:s.status||"active",conditionalRule:s.conditionalRule||null,conditionalParameters:s.conditionalParameters||{},createdAt:c,updatedAt:c},l={TableName:a,Item:d};return await e.put(l).promise(),r(201,{success:!0,message:"Discount created successfully",discount:d})}catch(e){return console.error("Error creating discount:",e),r(500,{success:!1,message:"Failed to create discount"})}}(n,f.business_id,JSON.parse(l||"{}")):"GET"===u&&d?.discountId?await async function(e,t,s){try{const n={TableName:a,Key:{business_id:t,discountId:s}},i=await e.get(n).promise();return i.Item?r(200,{success:!0,discount:i.Item}):r(404,{success:!1,message:"Discount not found"})}catch(e){return console.error("Error getting discount:",e),r(500,{success:!1,message:"Failed to retrieve discount"})}}(n,f.business_id,d.discountId):"PUT"===u&&d?.discountId?await async function(e,t,s,n){try{const i={TableName:a,Key:{businessId:t,discountId:s}};if(!(await e.get(i).promise()).Item)return r(404,{success:!1,message:"Discount not found"});const o=[],u={},c={},d=["title","description","value","applicability","applicableItemIds","applicableCategoryIds","minimumOrderAmount","validFrom","validTo","usageLimit","status","conditionalRule","conditionalParameters"];for(const e of d)void 0!==n[e]&&(o.push(`#${e} = :${e}`),u[`:${e}`]=n[e],c[`#${e}`]=e);o.push("#updatedAt = :updatedAt"),u[":updatedAt"]=(new Date).toISOString(),c["#updatedAt"]="updatedAt";const l={TableName:a,Key:{business_id:t,discountId:s},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeValues:u,ExpressionAttributeNames:c,ReturnValues:"ALL_NEW"},p=await e.update(l).promise();return r(200,{success:!0,message:"Discount updated successfully",discount:p.Attributes})}catch(e){return console.error("Error updating discount:",e),r(500,{success:!1,message:"Failed to update discount"})}}(n,f.business_id,d.discountId,JSON.parse(l||"{}")):"DELETE"===u&&d?.discountId?await async function(e,t,s){try{const n={TableName:a,Key:{business_id:t,discountId:s},ReturnValues:"ALL_OLD"};return(await e.delete(n).promise()).Attributes?r(200,{success:!0,message:"Discount deleted successfully"}):r(404,{success:!1,message:"Discount not found"})}catch(e){return console.error("Error deleting discount:",e),r(500,{success:!1,message:"Failed to delete discount"})}}(n,f.business_id,d.discountId):"PATCH"===u&&d?.discountId&&c.includes("/toggle-status")?await async function(e,t,s){try{const n={TableName:a,Key:{business_id:t,discountId:s}},i=await e.get(n).promise();if(!i.Item)return r(404,{success:!1,message:"Discount not found"});const o="active"===i.Item.status?"paused":"active",u={TableName:a,Key:{business_id:t,discountId:s},UpdateExpression:"SET #status = :status, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":status":o,":updatedAt":(new Date).toISOString()},ReturnValues:"ALL_NEW"},c=await e.update(u).promise();return r(200,{success:!0,message:`Discount status changed to ${o}`,discount:c.Attributes})}catch(e){return console.error("Error toggling discount status:",e),r(500,{success:!1,message:"Failed to toggle discount status"})}}(n,f.business_id,d.discountId):"POST"===u&&c.includes("/validate-discount")?await o(n,f.business_id,JSON.parse(l||"{}")):"POST"===u&&c.includes("/apply-discount")?await async function(e,t,s){try{const{discountId:n,orderTotal:i,items:u}=s,c=await o(e,t,s);if(200!==c.statusCode)return c;const d=JSON.parse(c.body),l=d.discount,p=d.discountAmount,m={TableName:a,Key:{business_id:t,discountId:n},UpdateExpression:"SET #usageCount = #usageCount + :inc, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#usageCount":"usageCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":inc":1,":updatedAt":(new Date).toISOString()}};return await e.update(m).promise(),r(200,{success:!0,message:"Discount applied successfully",discountAmount:p,finalTotal:i-p,discount:l})}catch(e){return console.error("Error applying discount:",e),r(500,{success:!1,message:"Failed to apply discount"})}}(n,f.business_id,JSON.parse(l||"{}")):"GET"===u&&c.includes("/stats")?await async function(e,t){try{const s={TableName:a,KeyConditionExpression:"businessId = :businessId",ExpressionAttributeValues:{":businessId":t}},n=(await e.query(s).promise()).Items||[],i={totalDiscounts:n.length,activeDiscounts:n.filter(e=>"active"===e.status).length,expiredDiscounts:n.filter(e=>new Date(e.validTo)<new Date).length,totalUsage:n.reduce((e,t)=>e+(t.usageCount||0),0),discountsByType:{}};return["percentage","fixedAmount","conditional","freeDelivery","buyXGetY","others"].forEach(e=>{i.discountsByType[e]=n.filter(t=>t.type===e).length}),r(200,{success:!0,stats:i})}catch(e){return console.error("Error getting discount stats:",e),r(500,{success:!1,message:"Failed to retrieve discount statistics"})}}(n,f.business_id):r(404,{success:!1,message:"Endpoint not found"}):r(404,{success:!1,message:"Business not found for user"})}catch(e){return console.error("Error in discount management handler:",e),r(500,{success:!1,message:"Internal server error",error:e.message})}}})();var i=exports;for(var r in n)i[r]=n[r];n.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();